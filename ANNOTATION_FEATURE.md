# SimpleShot 标注功能实现方案

## 概述

已成功为 SimpleShot 添加了截图标注功能。该功能支持在截图上进行多种标注操作，包括矩形、圆形、直线、箭头等。

## 已实现的功能

### 1. 标注工具

- **矩形** (Rectangle) - 绘制矩形框
- **圆形** (Circle) - 绘制圆形/椭圆
- **直线** (Line) - 绘制直线
- **箭头** (Arrow) - 绘制箭头
- **文字** (Text) - 添加文本（预留）
- **指针** (Pointer) - 选择工具

### 2. 编辑功能

- **撤销** (Undo) - 撤销最后一个标注
- **清除** (Clear) - 清除所有标注
- **保存** (Save) - 保存标注后的截图
- **取消** (Cancel) - 放弃编辑

### 3. UI 集成

- 在截图历史记录中添加了标注按钮
- 支持在历史记录中直接编辑任何截图
- 标注后的截图会替换原始截图显示

## 技术实现

### 使用的技术栈

- **完全基于原生 macOS APIs**，无需外部依赖
- AppKit (NSView, NSViewController, NSGraphicsContext)
- SwiftUI 用于 UI 集成
- CoreGraphics 用于绘图

### 文件结构

```
SimpleShot/
├── AnnotationEditor.swift      # 标注编辑器主类
├── ContentView.swift           # UI 视图（已更新）
└── ScreenshotManager.swift     # 截图管理器（已更新）
```

### 核心类

#### AnnotationEditorViewController

- 管理标注编辑器的整体逻辑
- 提供工具栏和按钮栏
- 处理用户交互

#### AnnotationCanvasView

- 继承自 NSView，用于绘制和编辑标注
- 支持鼠标事件处理
- 将标注后的图像导出为 NSImage

#### AnnotationElement

- 表示单个标注元素的数据结构
- 包含类型、坐标、颜色、线宽等信息

#### AnnotationTool

- 枚举类型，表示不同的标注工具

## 为什么不用现成的库

### 分析对比

| 库名                     | 语言       | 优点             | 缺点                   | 适配性 |
| ------------------------ | ---------- | ---------------- | ---------------------- | ------ |
| **Markup Kit**           | ObjC/Swift | 功能完整         | iOS 专属，不支持 macOS | ❌     |
| **Annotation Framework** | Swift      | 官方支持         | iOS/iPadOS 专属        | ❌     |
| **PinPoint**             | Swift      | 开源，轻量       | iOS 专属               | ❌     |
| **原生 AppKit**          | Swift      | 完全控制、无依赖 | 需要自己实现           | ✅     |

### 选择原生方案的原因

1. **项目约束** - SimpleShot 已经完全使用原生 API，无任何第三方依赖
2. **平台限制** - macOS 上的开源标注库极其稀少
3. **完全控制** - 能够精确控制功能和性能
4. **零依赖** - 便于分发和维护
5. **成本低** - 实现复杂度不高

## 使用指南

### 打开标注编辑器

1. 在截图历史记录中找到要标注的截图
2. 点击缩略图上的**铅笔按钮**（🖊️）
3. 或直接在历史记录菜单中打开

### 进行标注

1. 从左侧工具栏选择标注工具
2. 在图片上拖动鼠标进行绘制
3. 每次释放鼠标完成一个标注

### 保存标注

- 点击底部的**保存**按钮保存标注后的截图
- 标注后的截图将替换原始截图
- 同时保存标注历史记录

## 后续增强功能

可以继续扩展的功能：

### 短期

- [ ] 添加文本标注工具
- [ ] 支持更改标注颜色和线宽
- [ ] 添加橡皮擦工具
- [ ] 支持调整标注位置和大小

### 中期

- [ ] 支持标注撤销栈（当前只支持撤销最后一个）
- [ ] 添加更多绘图工具（矩形、模糊等）
- [ ] 保存标注为独立文件（JSON 格式）
- [ ] 快捷键支持

### 长期

- [ ] 支持从文件加载和编辑标注
- [ ] 标注模板库
- [ ] 离线存储和同步
- [ ] 支持批量标注

## 性能注意事项

当前实现的性能特性：

- ✅ 实时渲染标注
- ✅ 光滑的坐标映射
- ✅ 高分辨率屏幕支持（Retina）
- ⚠️ 大数量标注时可能影响性能（1000+ 个标注）

## 故障排除

### 问题：标注位置不正确

- **原因** - 坐标系转换误差（视图坐标 vs 图像坐标）
- **解决** - 已在绘图时考虑了图像缩放比例

### 问题：标注在保存后消失

- **原因** - 图像坐标系转换不正确
- **解决** - 确保在保存时使用原始图像尺寸坐标

### 问题：无法在编辑器中看到标注

- **原因** - 工具未被正确选中
- **解决** - 从工具栏选择工具后再尝试绘制

## 代码结构示例

```swift
// 创建标注编辑器
let editor = AnnotationEditorViewController(image: screenshot)
editor.onSave = { annotatedImage in
    // 处理保存
}

// 获取标注后的图像
let annotatedImage = canvasView.getAnnotatedImage()
```

## 许可证

SimpleShot - MIT License
